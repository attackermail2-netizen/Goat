#!/bin/bash

GITHUB_TOKEN="GITHUB_TOKEN" # Set your GitHub token here or export it in your environment
GITHUB_REPO="GITHUB_REPO" # Set your GitHub repository in the format owner/repo
GITHUB_API="https://api.github.com"

file=""
command=""
notification_mode="line"
bulk_filename="results.txt"

show_help() {
  cat <<EOF
Usage: $0 -f <filename> -c <command> [-m line|bulk] [-b bulk_filename]

Options:
  -f <filename>       Input file (required)
  -c <command>        Command to execute (required)
  -m <mode>           Notification mode: line|bulk (default:  line)
  -b <bulk_filename>  Output filename for bulk mode (default: results.txt)

Examples:
  $0 -f domains.txt -c "subfinder -silent | httpx -silent"
  $0 -f urls.txt -c "katana -silent -d 2" -m bulk -b crawled. txt

Available tools:  subfinder, httpx, nuclei, katana, notify
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -f) file="$2"; shift 2 ;;
    -c) command="$2"; shift 2 ;;
    -m) notification_mode="$2"; shift 2 ;;
    -b) bulk_filename="$2"; shift 2 ;;
    -h|--help) show_help; exit 0 ;;
    *) echo "Error: Unknown argument: $1"; show_help; exit 1 ;;
  esac
done

[[ -z "$file" ]] && { echo "Error: Input file required (-f)"; show_help; exit 1; }
[[ -z "$command" ]] && { echo "Error: Command required (-c)"; show_help; exit 1; }
[[ !  -f "$file" ]] && { echo "Error: File not found:  $file"; exit 1; }
[[ "$notification_mode" != "line" && "$notification_mode" != "bulk" ]] && { echo "Error: Invalid mode: $notification_mode"; exit 1; }
[[ -z "$GITHUB_TOKEN" ]] && { echo "Error: GITHUB_TOKEN not set"; exit 1; }

command -v jq &>/dev/null || { echo "Error: jq not installed"; exit 1; }

filename=$(basename "$file")
file_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
max_size=$((18 * 1024 * 1024))

[[ $file_size -gt $max_size ]] && { echo "Error: File too large (max 18MB)"; exit 1; }

echo "→ Uploading $filename ($(( file_size / 1024 ))KB)"
echo "→ Command: $command"
echo "→ Mode: $notification_mode"

sha_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
  "$GITHUB_API/repos/$GITHUB_REPO/contents/upload/$filename")

sha=""
if echo "$sha_response" | jq -e '.sha' >/dev/null 2>&1; then
  sha=$(echo "$sha_response" | jq -r '.sha')
  echo "→ Overwriting existing file"
fi

temp_json=$(mktemp)
temp_b64=$(mktemp)
trap "rm -f $temp_json $temp_b64" EXIT

base64 -w 0 "$file" > "$temp_b64"

{
  echo '{'
  echo "  \"message\": \"Upload $filename\","
  echo -n "  \"content\": \""
  cat "$temp_b64"
  echo "\""
  [[ -n "$sha" ]] && echo ",  \"sha\":  \"$sha\""
  echo '}'
} > "$temp_json"

upload_response=$(curl -s -X PUT \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Content-Type: application/json" \
  -d @"$temp_json" \
  "$GITHUB_API/repos/$GITHUB_REPO/contents/upload/$filename")

echo "$upload_response" | jq -e '.content' >/dev/null 2>&1 || {
  echo "Error: Upload failed"
  echo "$upload_response" | jq '.' 2>/dev/null || echo "$upload_response"
  exit 1
}

echo "✓ File uploaded"

workflow_payload="{
  \"ref\": \"main\",
  \"inputs\":  {
    \"file_name\": \"$filename\",
    \"command\": \"$command\",
    \"notification_mode\": \"$notification_mode\""

[[ "$notification_mode" == "bulk" ]] && workflow_payload+=",
    \"bulk_filename\": \"$bulk_filename\""

workflow_payload+="
  }
}"

echo "→ Triggering workflow..."

workflow_response=$(curl -s -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Content-Type: application/json" \
  -d "$workflow_payload" \
  "$GITHUB_API/repos/$GITHUB_REPO/actions/workflows/nuclei.yml/dispatches")

[[ -z "$workflow_response" ]] || {
  echo "Error:  Workflow trigger failed"
  echo "$workflow_response" | jq '.' 2>/dev/null || echo "$workflow_response"
  exit 1
}

echo "✓ Workflow triggered"
echo "→ Monitor:  https://github.com/$GITHUB_REPO/actions"
[[ "$notification_mode" == "bulk" ]] && echo "→ Results will be in $bulk_filename"
